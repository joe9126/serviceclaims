$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}});$(document).ready(function(){$("#projectslist_table").on("click","tbody tr",function(){var a=$(this).closest("tr").attr("id");$("#claimslist").fadeOut(),$("#claimslist").css("display","none"),$("#claimupdate").slideDown("slow"),b(a)})});$("#showlist").click(function(){$("#claimupdate").css("display","none").fadeOut(2e3),$("#claimslist").fadeIn(2e3),document.location.reload()});function b(a){$("#claimupdateform").trigger("reset"),$.ajax({type:"get",url:"ticketclaims/showclaim",data:{ticketno:a},dataType:"json",contentType:"false",processData:"false",success:function(e){console.log(e);var s=moment(e[0].ticketdate).format("Do MMM, YYYY"),t=e[0].clientname+", "+e[0].location+" On "+s;$("#cardtitle").text(t),$("#cardtitle-claimamount").text("| Kes. "+$.number(e[0].claimamount,2)),$("#claimno").val(e[0].claimno),$("#ticketno").val(e[0].ticketno),$("#busfare").val(e[0].psvfare),$("#lunch").val(e[0].lunch),$("#dinner").val(e[0].dinner),$("#accommodation").val(e[0].accommodation),$("#petties").val(e[0].petties),$("#kmtravel").val(e[0].km),$("#kmclaim").val($.number(e[0].kmclaim,2))},error:function(e){console.log("Error sending data."),console.log(e)}})}$(document).ready(function(){$(".calc").keyup(function(){var a=parseFloat($("#busfare").val())+parseFloat($("#lunch").val())+parseFloat($("#dinner").val())+parseFloat($("#accommodation").val())+parseFloat($("#petties").val())+parseFloat($("#kmclaim").val());$("#cardtitle-claimamount").text("| Kes. "+$.number(a,2))}),$("#kmtravel").keyup(function(){var a=parseFloat($("#kmtravel").val()),e=0,s=40,t=20;a>20?(a=a-20,e=a*t+s*20,$("#kmclaim").val(e)):(e=s*a,$("#kmclaim").val(e));var l=parseFloat($("#busfare").val())+parseFloat($("#lunch").val())+parseFloat($("#dinner").val())+parseFloat($("#accommodation").val())+parseFloat($("#petties").val())+parseFloat($("#kmclaim").val());$("#cardtitle-claimamount").text("| Kes. "+$.number(l,2))})});$("#travelmode").on("change",function(){$(this).val()=="Private"?($(".kmtravel").css("display","block"),$(".busfare").css("display","none"),$(".companyprovided").css("display","none")):$(this).val()=="Public"?($(".companyprovided").css("display","none"),$(".kmtravel").css("display","none"),$(".busfare").css("display","block")):($(".companyprovided").css("display","block"),$(".kmtravel").css("display","none"),$(".busfare").css("display","none"))});$("#claimupdateform").on("submit",function(a){a.preventDefault();var e=$("#claimno").val();if(console.log("claim no: "+e),e!=="NA")$(".message").text("This ticket is already claimed. Contact admin now."),$("#alertmessage2").removeClass("alert-success"),$("#alertmessage2").addClass("alert-danger"),$("#alertmessage2").css("display","block").fadeOut(3500);else if($("#claimupdateform").parsley(),$("#claimupdateform").parsley().isValid()){var s=parseFloat($("#busfare").val())+parseFloat($("#lunch").val())+parseFloat($("#dinner").val())+parseFloat($("#accommodation").val())+parseFloat($("#petties").val())+parseFloat($("#kmclaim").val());if(window.FormData!==void 0){var t=new FormData(this);t.append("claimtotal",s);var l=$("#claimsubmit").clone();$.ajax({url:"claimupdate",method:"post",data:t,processData:!1,contentType:!1,beforeSend:function(){var i='<div class="spinner-border text-light fs-5" role="status"><span class="visually-hidden">Loading...</span></div>';$("#claimsubmit").html("Updating "+i)},success:function(i){$("#claimsubmit").replaceWith(l),i.success==!0?($(".message").text(i.message),$("#alertmessage2").removeClass("alert-danger"),$("#alertmessage2").addClass("alert-success"),$("#alertmessage2").css("display","block").fadeOut(3e3),$("#claimupdateform")[0].reset(),$("#claimupdateform").parsley().reset()):($("#claimsubmit").replaceWith(l),$(".message").text(i.message),$("#alertmessage2").removeClass("alert-success"),$("#alertmessage2").addClass("alert-danger"),$("#alertmessage2").css("display","block").fadeOut(3e3))},error:function(i){$(".message").text("An error occured. Claim was not updated"),$("#alertmessage2").removeClass("alert-success"),$("#alertmessage2").addClass("alert-danger"),$("#alertmessage2").css("display","block").fadeOut(3e3),console.log("Error sending data."),console.log(i)}})}}});$("#removeclaimbtn").click(function(){var a=$("#claimprinttable").find(":checked").length;if(!a)$(".message").text("Select at least one claim."),$("#alertmessage").removeClass("alert-success"),$("#alertmessage").addClass("alert-danger"),$("#alertmessage").css("display","block").fadeOut(3e3);else{$("#claimprinttable tbody tr").find('input[name="flexCheckDefault"]').each(function(){$(this).is(":checked")&&$(this).parents("tr").remove()});for(var e=$("#claimprinttable >tbody >tr").length,s=0,t=0,l=1;l<=e;l++)t=$("#claimprinttable tbody tr:nth-child("+l+")").find("td:nth-child(11)").text().replace("KES. ",""),t=parseFloat(t.replace(",","")),s+=t;$("#totalamounttxt").text("KES. "+$.number(s,2))}});$("#deleteclaimbtn").click(function(){var a=$("#claimprinttable").find(":checked").length;a?$("#claimprinttable >tbody>tr").find('input[name="flexCheckDefault"]:checked').each(function(){var e={ticketno:$(this).parents("tr").attr("id")},s=2e3;$.ajax({url:"/delete",method:"post",dataType:"json",data:e,success:function(t){t.success==!0?($(".message").text(t.message),$("#alertmessage").removeClass("alert-danger"),$("#alertmessage").addClass("alert-success"),$("#alertmessage").css("display","block").fadeOut(3e3),setTimeout(function(){$('input[type="checkbox"]').removeAttr("checked"),document.location.reload()},s)):($(".message").text(t.message),$("#alertmessage").removeClass("alert-success"),$("#alertmessage").addClass("alert-danger"),$("#alertmessage").css("display","block").fadeOut(3e3))},error:function(t){console.log("Error sending data."),console.log(t)}})}):($(".message").text("Select at least one claim."),$("#alertmessage").removeClass("alert-success"),$("#alertmessage").addClass("alert-danger"),$("#alertmessage").css("display","block").fadeOut(3e3))});$("#printclaimpreviewbtn").click(function(a){a.preventDefault();var e=$("#totalamounttxt").text().replace("KES. ",""),s=parseFloat(e.replace(",","")),t=$("#claimprinttable >tbody >tr").length;if(s==null||s==0)$(".message").text("Claim amount should be greater than 0."),$(".spinner-border").removeClass("text-success"),$(".spinner-border").addClass("text-danger"),$("#alertmessage").removeClass("alert-success"),$("#alertmessage").addClass("alert-danger"),$("#alertmessage").css("display","block").fadeOut(5e3);else if(t>5)$(".message").text("You can print a maximum of 5 service ticket claims."),$(".spinner-border").removeClass("text-success"),$(".spinner-border").addClass("text-danger"),$("#alertmessage").removeClass("alert-success"),$("#alertmessage").addClass("alert-danger"),$("#alertmessage").css("display","block").fadeOut(4e3);else{for(var l,i,n,o,r,m,u,p,d,f={},v=[],t=$("#claimprinttable >tbody >tr").length,g=new FormData,c=1;c<=t;c++)l=$("#claimprinttable tbody tr:nth-child("+c+")").find("td:nth-child(3)").text(),u=$("#claimprinttable tbody tr:nth-child("+c+")").find("td:nth-child(4)").text(),p=$("#claimprinttable tbody tr:nth-child("+c+")").find("td:nth-child(5)").text(),i=$("#claimprinttable tbody tr:nth-child("+c+")").find("td:nth-child(6)").text(),n=$("#claimprinttable tbody tr:nth-child("+c+")").find("td:nth-child(7)").text(),o=$("#claimprinttable tbody tr:nth-child("+c+")").find("td:nth-child(8)").text(),r=$("#claimprinttable tbody tr:nth-child("+c+")").find("td:nth-child(9)").text(),m=$("#claimprinttable tbody tr:nth-child("+c+")").find("td:nth-child(10)").text(),d=$("#claimprinttable tbody tr:nth-child("+c+")").find("td:nth-child(11)").text().replace("KES. ",""),d=parseFloat(d.replace(",","")),f={ticketno:l,jobcardno:i,billingrefno:n,client:o,task:r,location:m,date:u,time:p,amount:d},v.push(f);g.append("claimsdata",JSON.stringify(v)),$.ajax({url:"/printpreview",method:"post",data:g,processData:!1,contentType:!1,success:function(h){h.success==!0&&($(".message").text(h.message),$("#alertmessage").removeClass("alert-danger"),$("#alertmessage").addClass("alert-success"),$("#alertmessage").css("display","block").fadeOut(5e3),setTimeout(function(){window.open("/printpreview","Print Claims","width=1200,height=900,scrollbars=yes")},2e3))}})}});$(document).ready(function(){var a=window.location.pathname;if(a=="/printpreview"){var e=new Date,s=e.getMonth()+1,t=e.getDate(),l=e.getFullYear()+((""+s).length<2?"0":"")+s+((""+t).length<2?"0":"")+t,i=Math.floor(Math.random()*1e4)+1;$("#claimno").text(l+"/"+i)}});$("#exitbtn").click(function(){$("#showprintout").css("display","none").fadeOut(2e3),$("#showclaimlist").fadeIn(2e3)});$("#printclaims").click(function(){var a=$("#claimno").text();$.ajax({url:"/resetprintclaims",data:{claimno:a},dataType:"json",method:"get",success:function(e){if(e.success==!0){var s="@page { size: landscape; }",t=document.head||document.getElementsByTagName("head")[0],l=document.createElement("style");l.type="text/css",l.media="print",l.styleSheet?l.styleSheet.cssText=s:l.appendChild(document.createTextNode(s)),t.appendChild(l),window.print(),document.location.reload()}},error:function(e){console.log("Error sending data."),console.log(e)}})});$(document).ready(function(){var a=window.location.pathname;a=="/servicetickets"&&$("#serviceticketstable").DataTable(),a=="/dashboard"&&(console.log("path: "+a),$.ajax({url:"dashboardinfo",method:"get",dataType:"json",success:function(e){$.each(e,function(s,t){e[0]==null?$("#claimtotal").text("KES. 0.00"):$("#claimtotal").text("KES. "+$.number(e[0].totalclaim)),e[1]!==null&&$("#unupdatedclaims").text($.number(e[1].unupdatedclaims,0)+" Tickets"),e[2]!==null&&$("#pendingtickets").text($.number(e[2].pendingtickets,0)+" Tickets")})}}))});$(function(){$(".datepicker").datetimepicker({value:"",rtl:!1,format:"d-m-Y H:i",formatTime:"H:i",formatDate:"d-m-Y",step:30,monthChangeSpinner:!0,closeOnDateSelect:!1,closeOnTimeSelect:!0,closeOnWithoutClick:!0,closeOnInputClick:!0,openOnFocus:!0,timepicker:!0,datepicker:!0})});$("#exitupdate").on("click",function(a){a.preventDefault(),$("#ticketupdate").fadeOut(),$("#ticketupdate").css("display","none"),$("#ticketlist").fadeIn(2e3),document.location.reload()});$("#serviceticketstable").on("click","tbody tr",function(){$("#ticketlist").fadeOut(),$("#ticketlist").css("display","none"),$("#ticketupdate").fadeIn(1e3);var a=$(this).closest("tr").attr("id");$.ajax({url:"showticket",type:"get",data:{ticketno:a},dataType:"json",beforeSend:function(){},success:function(e){$("#ticketno").text(e[0].ticketno);var s="Ticket # "+e[0].ticketno+" | "+e[0].clientname+" | "+moment(e[0].ticketdate).format("ddd d MMM, YYYY");if($("#cardtitle").text(s),$("#jobcardno").val(e[0].jobcardno),$("#site").val(e[0].site),e[0].start_time!="no update"&&$("#startdatetime").val(e[0].start_time),e[0].end_time!="no update"&&$("#enddatetime").val(e[0].end_time),$("#equipmodel").val(e[0].model),$("#serialno").val(e[0].serialno),$("#findings").val(e[0].findings),$("#action_taken").val(e[0].action_taken),$("#recommendations").val(e[0].recommendations),e[0].attachment!="no file found"){$(".filelist").css("display","block"),$("#filename").text(e[0].attachment);var t=/^((http|https|ftp):\/\/)/;t.test(e[0].attachment)&&$("#filename").attr("href",e[0].attachment)}},error:function(e){console.log("Error sending data."),console.log(e)}})});$(document).on("submit","#ticketupdateform",function(a){a.preventDefault(),$("#ticketupdateform").parsley();var e=new Date($("#startdatetime").val().replace(/(\d{2})-(\d{2})-(\d{4})/,"$2/$1/$3")),s=new Date($("#enddatetime").val().replace(/(\d{2})-(\d{2})-(\d{4})/,"$2/$1/$3"));if($("#ticketupdateform").parsley().isValid())if(!$("#jobcardupload").val()&&!$("#filename").text())$("#alertmessage2").focus(),$(".message").text("Attach the job card."),$("#alertmessage2").removeClass("alert-success"),$("#alertmessage2").addClass("alert-danger"),$("#alertmessage2").css("display","block").fadeOut(1e4),$("#alertmessage2")[0].scrollIntoView();else if(moment(s).isBefore(moment(e)))$("#alertmessage2").focus(),$(".message").text("Start time should be earier than end time."),$("#alertmessage2").removeClass("alert-success"),$("#alertmessage2").addClass("alert-danger"),$("#alertmessage2").css("display","block").fadeOut(1e4),$("#alertmessage2")[0].scrollIntoView();else{var t=new FormData;t.append("ticketno",$("#ticketno").text()),t.append("jobcardno",$("#jobcardno").val()),t.append("city",$("#site").val()),t.append("start_time",moment(e).format("YYYY-MM-DD HH:mm:ss")),t.append("end_time",moment(s).format("YYYY-MM-DD HH:mm:ss")),t.append("model",$("#equipmodel").val()),t.append("serialno",$("#serialno").val()),t.append("findings",$("#findings").val()),t.append("action_taken",$("#action_taken").val()),t.append("recommendations",$("#recommendations").val()),t.append("status",$("#ticketstatus option:selected").val());var l=$("#jobcardupload")[0].files[0],i=$.trim($("#jobcardupload").val()),n=$("#jobcardupload").val().split("\\").pop();n=$("#ticketno").text()+"- "+$("#jobcardno").val()+"-"+n,console.log(n),n!=null&&i!==""&&i?(t.append("attachment",l),t.append("filename",n),console.log("file attached")):(n=$("#filename").text(),t.append("filename",n));var o=$("#submitupdate").clone();$.ajax({url:"ticket/update",type:"post",data:t,dataType:"json",processData:!1,contentType:!1,beforeSend:function(){var r='<div class="spinner-border text-light fs-5" role="status"><span class="visually-hidden"> Loading...</span></div>';$("#submitupdate").html("Updating "+r)},success:function(r){$("#submitupdate").replaceWith(o),r.success==!0?($(".message").text(r.message),$("#alertmessage2").removeClass("alert-danger"),$("#alertmessage2").addClass("alert-success"),$("#alertmessage2").css("display","block").fadeOut(5e3),$(".top-row")[0].scrollIntoView(),$("#ticketupdateform")[0].reset(),$("#ticketupdateform").parsley().reset()):($("#submitupdate").replaceWith(o),$(".message").text(r.message),$("#alertmessage2").removeClass("alert-success"),$("#alertmessage2").addClass("alert-danger"),$("#alertmessage2").css("display","block").fadeOut(5e3),$("#alertmessage2")[0].scrollIntoView())},error:function(r){$("#submitupdate").replaceWith(o),console.log("error occured")}})}});$("#downloadjobcardbtn").on("click",function(a){a.preventDefault();var e=$("#filename").text();$.ajax({url:"ticket/checkfile?filename="+e,type:"get",success:function(s){s.success==!0?(window.location.href="ticket/downloadjobcard?filename="+e,$(".message").text(s.message),$("#alertmessage2").removeClass("alert-danger"),$("#alertmessage2").addClass("alert-success"),$("#alertmessage2").css("display","block").fadeOut(5e3),$(".top-row")[0].scrollIntoView()):($(".message").text(s.message),$("#alertmessage2").removeClass("alert-success"),$("#alertmessage2").addClass("alert-danger"),$("#alertmessage2").css("display","block").fadeOut(5e3),$(".top-row")[0].scrollIntoView())}})});$("#projectslist_table").DataTable();$("#claimprinttable").DataTable();
